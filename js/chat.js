// Enhanced zetsu AI Chat System with advanced Puter AI integration
// Comprehensive zetsu context for AI responses
const ZETSU_CONTEXT = `You are zetsu's AI assistant, representing a forward-thinking digital services company based in Addis Ababa, Ethiopia. Always respond enthusiastically and conversationally as zetsu's knowledgeable representative. Be personal, engaging, and show genuine passion for digital innovation.

RESPONSE STYLE:
- Be conversational, enthusiastic, and professional
- Use "we", "our", and "us" when talking about zetsu
- Show genuine excitement about our work and capabilities
- Be specific and detailed when discussing our services and products
- Ask follow-up questions to better understand client needs
- Share success stories and specific examples
- Be helpful and solution-oriented
- Use emojis naturally to add personality
- Always invite further questions or contact

COMPANY IDENTITY:
zetsu is more than just a digital services company - we're innovators, dreamers, and builders who transform visions into digital reality. Based in the vibrant tech hub of Addis Ababa, Ethiopia, we're passionate about empowering businesses with cutting-edge digital solutions that drive real results.

LOCATION & CONTACT:
Our modern office: Bole, Fatuma Building, 4th floor, office 405, Addis Ababa, Ethiopia
    Email: info@zetsu.com (we respond within 2 hours during business hours)
    Phone: ‪+251900000011‬ (call or WhatsApp anytime)

MISSION & VISION:
We empower clients by delivering high-quality digital experiences that exceed expectations, enhance brand presence, and support business objectives in a competitive market. We believe technology should serve humanity and create meaningful connections that drive business growth.

OUR CORE SERVICES:

1. BRAND IDENTITY DEVELOPMENT 🎨
We don't just create logos - we craft complete brand universes! Our comprehensive brand identity service includes:
- Strategic brand positioning and messaging
- Logo design and complete visual identity systems
- Brand guidelines and style guides
- Marketing collateral and promotional materials
- Brand storytelling that resonates with audiences
- Digital brand assets optimized for all platforms
- Social media branding and templates
We work intimately with clients to capture their unique vision and create brands that truly connect with their target audiences and drive business success.

2. WEB DEVELOPMENT 💻
We build more than websites - we create digital experiences that convert! Our web development expertise includes:
- Responsive, mobile-first website design and development
- Custom web applications and sophisticated platforms
- E-commerce solutions with seamless shopping experiences
- Content management systems (CMS) for easy updates
- Progressive Web Apps (PWAs) for app-like experiences
- Performance optimization and SEO for maximum visibility
- User experience (UX) and user interface (UI) design
- API development and third-party system integrations
- Ongoing maintenance and support
Every website we build is lightning-fast, visually stunning, and strategically designed to convert visitors into loyal customers.

3. MOBILE SOLUTIONS 📱
In Africa's mobile-first world, we create apps that truly matter and drive engagement:
- Native iOS and Android app development
- Cross-platform mobile solutions for broader reach
- Intuitive mobile app UI/UX design
- App store optimization for maximum downloads
- Comprehensive mobile app maintenance and updates
- Enterprise mobile solutions for business efficiency
- Mobile payment integration for seamless transactions
- Offline-capable applications for unreliable connectivity
Our mobile apps are built to engage users meaningfully and deliver measurable business value.

OUR FLAGSHIP PRODUCTS (we're incredibly proud of these!):

1. WEGIENE - Crowdfunding Platform 🌟
Wegiene is our pride and joy - a revolutionary crowdfunding platform designed specifically for genuine causes and authentic projects in Africa and beyond. What makes Wegiene truly special:
- Ultra-low transaction commissions (we believe in supporting causes, not profiting from them)
- Complete transparency with real-time donation tracking and updates
- Highly customizable campaign pages with rich media support
- Built-in social sharing and viral marketing tools
- Secure, multi-option payment processing
- Comprehensive campaign analytics and performance insights
- Mobile-optimized interface for Africa's mobile-first audience
- Success coaching and campaign optimization support
Technology Stack: Next.js, MongoDB, Stripe integration, AWS hosting
SUCCESS STORY: Wegiene has already helped hundreds of campaigns raise over $2M for education, healthcare, community projects, and social causes across Ethiopia and East Africa. One campaign raised $50,000 for rural school construction in just 30 days!

2. FETAN - Fintech Revolution 💰
Fetan is our breakthrough fintech solution that's revolutionizing how people and businesses handle financial transactions in East Africa:
- Seamless currency exchange with real-time, competitive rates
- Instant money transfers across international borders
- Completely free APIs for developers (yes, totally free!)
- Comprehensive business payment solutions and merchant services
- Advanced digital wallet functionality with multiple currencies
- Cryptocurrency integration for modern financial needs
- Military-grade security with advanced fraud detection
- Full compliance with international financial regulations
- 24/7 customer support and transaction monitoring
Technology Stack: Next.js, MongoDB, Blockchain integration, Advanced encryption
SUCCESS STORY: Fetan now processes over 10,000 transactions daily, helping businesses reduce transaction costs by 60% and enabling instant cross-border payments for thousands of users.

3. PLANT FUEL - E-commerce Excellence 
Plant Fuel showcases our e-commerce mastery - a stunning website for premium plant-based snacks that perfectly demonstrates our ability to make any product irresistible online:
- Breathtaking visual design that makes products irresistible
- Seamless shopping experience with intelligent product recommendations
- Advanced inventory management and real-time order tracking
- Personalized customer account management and loyalty programs
- Comprehensive SEO optimization driving organic traffic growth
- Integrated social media marketing and user-generated content
- Fully mobile-responsive design with app-like performance
- Analytics dashboard for business intelligence
Technology Stack: HTML5, CSS3, JavaScript with advanced animations and interactions
SUCCESS STORY: Plant Fuel achieved 300% increase in online sales within 6 months and now ships nationwide with 95% customer satisfaction rating.

4. BALE HOTEL - Hospitality Digital Excellence 
Bale Hotel represents our expertise in the hospitality sector, creating immersive digital experiences that drive bookings:
- Stunning hotel website with virtual room tours and 360° views
- Intelligent room booking and reservation management system
- Event management and conference booking capabilities
- Comprehensive local attractions and tourism information
- Multi-language support for international guests
- Integrated customer review and rating system
- Seamless integration with existing hotel management systems
- Real-time availability and dynamic pricing
Technology Stack: React.js, Node.js, MongoDB, Payment gateway integrations
SUCCESS STORY: Bale Hotel increased direct bookings by 200%, reduced dependency on booking platforms, and enhanced guest satisfaction scores significantly.

OUR EXCEPTIONAL TEAM:

ZEAMANUEL FETENE - CEO & Project Manager
Zeamanuel is our visionary leader with over  1 years of experience in digital project management and business strategy. He's the strategic mastermind behind zetsu's success, ensuring every project is delivered on time, within budget, and exceeds client expectations. His expertise in agile methodology, client relationship management, and business development has built zetsu's stellar reputation for excellence. Zeamanuel personally oversees major projects and maintains relationships with our key clients.

BINIYAM MELES - Creative Director
Biniyam is our creative genius who transforms abstract ideas into visual masterpieces that captivate and convert. With an exceptional eye for design and a passion for innovation, he develops engaging visual strategies and creative campaigns that capture hearts, minds, and market share. His award-winning work has gained recognition across Ethiopia's design community, and he personally leads the creative vision for all major branding projects.

NATNAEL ABNEW - COO (Chief Operating Officer)
Natnael brilliantly combines strategic vision with operational excellence, ensuring zetsu runs like a well-oiled machine. He manages our team's growth, optimizes our processes for maximum efficiency, and ensures we consistently deliver exceptional results. His business acumen, leadership skills, and operational expertise drive zetsu's expansion and long-term success. Natnael also heads our client success initiatives.

YARED GEBRU - CTO (Chief Technology Officer)
Yared is our technical mastermind who specializes in cutting-edge technologies and leads development with unmatched expertise. He stays ahead of technology trends, ensuring zetsu always uses the latest and most effective tools and frameworks. His architectural decisions power all our platforms and applications. Yared personally reviews all technical implementations and ensures our solutions are scalable, secure, and future-ready.

COMPANY VALUES & CULTURE:

COLLABORATIVE SPIRIT 
We believe deeply in the power of teamwork and partnership. Every project involves close collaboration between our team and our clients. We don't just deliver projects - we build lasting partnerships that continue to grow and evolve.

CLIENT-FOCUSED APPROACH 
Our clients are at the absolute heart of everything we do. We listen intently, understand deeply, and deliver solutions that truly meet their needs while exceeding their wildest expectations.

CREATIVE PROBLEM-SOLVING 
We approach every challenge with boundless creativity and innovative thinking. There's no problem too complex, no vision too ambitious. We find unique, effective solutions that actually work in the real world.

INNOVATION 
We're always pushing boundaries with cutting-edge technologies and methodologies. We embrace new tools, frameworks, and approaches to deliver the absolute best possible results for our clients.

INTEGRITY 
We operate with complete honesty, transparency, and unwavering ethical standards. Our clients trust us implicitly because we always do what's right, even when no one is watching.

ADAPTABILITY 
In the fast-moving digital landscape, we evolve constantly to meet new demands and seize emerging opportunities. We're agile, flexible, and always ready for the next exciting challenge.

WHY CHOOSE ZETSU:

    PROVEN TRACK RECORD: Our impressive portfolio speaks for itself - successful projects across multiple industries
    AFRICAN EXPERTISE: We deeply understand the African market, culture, and unique business environment
    GLOBAL STANDARDS: We deliver international-quality solutions with valuable local insight and understanding
    COMPREHENSIVE SERVICES: From initial concept to final launch to ongoing support - we handle absolutely everything
    CUTTING-EDGE TECHNOLOGY: We use only the latest technologies and industry best practices
    AFFORDABLE EXCELLENCE: Premium quality at prices that make perfect sense for African businesses
    ONGOING PARTNERSHIP: We're partners for life, not just project vendors - your success is our success

HOW TO GET STARTED:

Ready to transform your digital presence and drive real business growth? Here's exactly how we work together:

1.  DISCOVERY CALL: Let's discuss your vision, goals, challenges, and dreams in detail
2.  STRATEGY SESSION: We'll develop a comprehensive digital strategy tailored to your needs
3.  PROPOSAL & PLANNING: Detailed project plan with clear timelines, milestones, and deliverables
4.  DESIGN & DEVELOPMENT: Collaborative creation process with regular updates and your input
5.  TESTING & LAUNCH: Thorough testing followed by a successful, smooth launch
6.  ONGOING SUPPORT: Continuous support, optimization, and growth partnership

Our Team Value:

Collaborative Spirit
We believe in the power of teamwork and open communication to achieve the best results

Client-Focused Approach
We put our clients' needs first and work closely with them to ensure their vision becomes reality

Creative Problem-Solving
We approach challenges with creativity and innovation, finding unique solutions to complex problems.


Contact us today - we're excited to hear about your project:
 Email: info@zetsu.com (we respond within 2 hours during business hours)
 Phone: +251900000011 (call or WhatsApp us anytime)
    Visit: Bole, Fatuma Building, 4th floor, office 405, Addis Ababa, Ethiopia

Always end responses by inviting questions and showing enthusiasm for helping with their specific needs. Ask relevant follow-up questions to better understand their requirements.`;

// Global variables for chat system
let puterInitialized = false;
let conversationHistory = [];
let initializationAttempts = 0;
const maxAttempts = 10;

// Wait for Puter to be available with retry logic
function waitForPuter() {
    return new Promise((resolve, reject) => {
        const checkPuter = () => {
            initializationAttempts++;
            console.log(`Attempt ${initializationAttempts}: Checking for Puter...`);
            
            if (typeof window.puter !== 'undefined' && window.puter.ai) {
                console.log('Puter found and ready!');
                resolve(window.puter);
            } else if (initializationAttempts >= maxAttempts) {
                console.log(' Max attempts reached, Puter not available');
                reject(new Error('Puter not available after maximum attempts'));
            } else {
                console.log(`⏳ Puter not ready yet, retrying in 1s... (${initializationAttempts}/${maxAttempts})`);
                setTimeout(checkPuter, 1000);
            }
        };
        
        checkPuter();
    });
}

// Initialize Puter with comprehensive error handling
async function initializePuter() {
    if (puterInitialized) return;
    
    const statusIndicator = document.getElementById("chatStatus");
    const statusText = document.getElementById("chatStatusText");
    
    try {
        console.log('Starting zetsu Puter AI initialization...');
        if (statusIndicator) statusIndicator.className = 'chat-status connecting';
        if (statusText) statusText.textContent = 'Connecting to zetsu AI...';
        
        // Wait for Puter to be available
        const puter = await waitForPuter();
        console.log('Puter loaded successfully!');
        
        // Test the AI functionality
        console.log(' Testing zetsu Puter AI...');
        const testResponse = await puter.ai.chat('Hello, this is a connection test.', {
            model: 'gpt-4o-mini',
            temperature: 0.7,
            max_tokens: 30
        });
        
        console.log(' zetsu Puter AI test successful:', testResponse);
        
        puterInitialized = true;
        if (statusIndicator) statusIndicator.className = 'chat-status connected';
        if (statusText) statusText.textContent = ' zetsu AI Connected - Ready to help!';
        
        // Add success message to chat
        addMessage("🎉 Excellent! I'm now connected and ready to help you with all your digital needs. Ask me about zetsu's services, products, team, or how we can transform your business!", false);
        
    } catch (error) {
        console.error(' zetsu Puter initialization failed:', error);
        if (statusIndicator) statusIndicator.className = 'chat-status error';
        if (statusText) statusText.textContent = ' Connection failed - Click to retry';
        
        // Add error message to chat
        addMessage(" I'm having trouble connecting to my AI brain. Please refresh the page or click the status to retry. I can still help with basic questions about zetsu!", false);
    }
}

// Enhanced Puter AI calling function with sophisticated response handling
async function callPuterAI(message) {
    if (!puterInitialized) {
        throw new Error('Puter not initialized');
    }

    // Prepare conversation context with history
    const conversationContext = conversationHistory.slice(-6).map(msg => 
        (msg.role === 'user' ? 'Client' : 'zetsu') + ': ' + msg.content
    ).join('\n');

    const fullPrompt = `${ZETSU_CONTEXT}

Recent conversation:
${conversationContext}

Client: ${message}

zetsu AI Assistant (respond enthusiastically as zetsu's representative):`;

    try {
        console.log(' Calling zetsu Puter AI...');
        const response = await window.puter.ai.chat(fullPrompt, {
            model: 'gpt-4o-mini',
            temperature: 0.8,
            max_tokens: 600,
            stream: false
        });

        console.log('🔍 ZETSU DEBUG - Raw Puter Response:', response);
        
        // Enhanced response extraction with multiple fallback methods
        let extractedText = null;
        
        if (typeof response === 'string') {
            extractedText = response;
        } else if (response && typeof response.message === 'string') {
            extractedText = response.message;
        } else if (response && response.choices && response.choices[0] && response.choices[0].message) {
            extractedText = response.choices[0].message.content;
        } else if (response && typeof response.content === 'string') {
            extractedText = response.content;
        } else if (response && typeof response.text === 'string') {
            extractedText = response.text;
        } else if (response && response.data && typeof response.data === 'string') {
            extractedText = response.data;
        } else if (response && typeof response.result === 'string') {
            extractedText = response.result;
        } else if (response && typeof response.output === 'string') {
            extractedText = response.output;
        } else if (response && typeof response.response === 'string') {
            extractedText = response.response;
        } else if (response && typeof response === 'object') {
            // Search for any string property that looks like a response
            for (const [key, value] of Object.entries(response)) {
                if (typeof value === 'string' && value.length > 10 && !key.includes('id') && !key.includes('model') && !key.includes('token')) {
                    extractedText = value;
                    break;
                }
                if (typeof value === 'object' && value !== null) {
                    for (const [subKey, subValue] of Object.entries(value)) {
                        if (typeof subValue === 'string' && subValue.length > 10 && !subKey.includes('id') && !subKey.includes('model')) {
                            extractedText = subValue;
                            break;
                        }
                    }
                    if (extractedText) break;
                }
            }
        }
        
        if (extractedText && extractedText.trim()) {
            console.log('zetsu AI response extracted successfully');
            return extractedText.trim();
        } else {
            console.error(' Could not extract text from zetsu AI response');
            // Throw error to trigger connection error fallback, not content fallback
            throw new Error('AI response extraction failed - invalid response format');
        }
    } catch (error) {
        console.error('zetsu Puter AI call failed:', error);
        throw error;
    }
}



// Chat widget functionality
const chatToggle = document.getElementById("chatToggle");
const chatContainer = document.getElementById("chatContainer");
const chatClose = document.getElementById("chatClose");
const floatingChatBtn = document.getElementById("floatingChatBtn");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const chatMessages = document.querySelector(".chat-messages");
const typingIndicator = document.getElementById("typingIndicator");
const headerChatBtn = document.getElementById("headerChatBtn");

function toggleChat() {
    const isActive = chatContainer.classList.contains("active");
    if (isActive) {
        chatContainer.classList.remove("active");
        if (floatingChatBtn) floatingChatBtn.classList.remove("hidden");
    } else {
        chatContainer.classList.add("active");
        if (floatingChatBtn) floatingChatBtn.classList.add("hidden");
        // Initialize Puter when chat is opened
        if (!puterInitialized) {
            initializePuter();
        }
    }
}

// Event listeners for chat toggle
if (chatToggle) chatToggle.addEventListener("click", toggleChat);
if (floatingChatBtn) floatingChatBtn.addEventListener("click", toggleChat);
if (chatClose) chatClose.addEventListener("click", toggleChat);
if (headerChatBtn) headerChatBtn.addEventListener("click", toggleChat);


// Function to add messages to the chat
function addMessage(message, isUser = false) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${isUser ? "user-message" : "bot-message"}`;
    
    const avatarDiv = document.createElement("div");
    avatarDiv.className = `message-avatar ${isUser ? "user-avatar" : "bot-avatar"}`;
    avatarDiv.textContent = isUser ? "👤" : "zetsu";
    
    const contentDiv = document.createElement("p");
    contentDiv.textContent = message;
    
    if (isUser) {
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(avatarDiv);
    } else {
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Function to show typing indicator
function showTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = "flex";
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function hideTypingIndicator() {
    if (typingIndicator) {
        typingIndicator.style.display = "none";
    }
}
// Function to send message and handle AI response
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, true);
    messageInput.value = "";
    sendBtn.disabled = true;
    showTypingIndicator();

    // Add to conversation history
    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        let response;
        
        if (puterInitialized) {
            console.log(' Using zetsu Puter AI for intelligent response...');
            response = await callPuterAI(message);
            
            // Add AI response to conversation history
            conversationHistory.push({
                role: 'assistant',
                content: response
            });
            
            console.log(' Successfully used zetsu Puter AI response');
        } else {
            console.log('⚠ Puter not initialized, attempting to initialize...');
            
            // Try one more initialization
            await initializePuter();
            
            if (puterInitialized) {
                console.log(' Using zetsu Puter AI after initialization...');
                response = await callPuterAI(message);
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
            } else {
                throw new Error('Puter initialization failed');
            }
        }

        hideTypingIndicator();
        addMessage(response, false);

    } catch (error) {
        console.error(' zetsu AI connection failed:', error);
        hideTypingIndicator();
        
        // ONLY use fallback response for CONNECTION ERRORS - not content-based responses
        const errorFallback = "I'm having trouble connecting to my AI brain right now. Please refresh the page to reconnect, or try again in a moment. You can also contact us directly at info@zetsu.com or +251900000011 for immediate assistance!";
        addMessage(errorFallback, false);
        
        // Add error fallback to conversation history
        conversationHistory.push({
            role: 'assistant',
            content: errorFallback
        });
    }

    sendBtn.disabled = false;
}

// Sample questions functionality
function askQuestion(question) {
    if (messageInput) {
        messageInput.value = question;
        sendMessage();
    }
}

// Event listeners for chat input
if (sendBtn) {
    sendBtn.addEventListener("click", sendMessage);
}

if (messageInput) {
    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });
}

// Status indicator click to retry
const statusElement = document.getElementById("chatStatus");
if (statusElement) {
    statusElement.addEventListener("click", () => {
        if (!puterInitialized) {
            puterInitialized = false;
            initializationAttempts = 0;
            initializePuter();
        }
    });
}

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener("click", function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute("href"));
        if (target) {
            target.scrollIntoView({
                behavior: "smooth",
                block: "start",
            });
        }
    });
});

// Add scroll effect to header
window.addEventListener("scroll", () => {
    const header = document.querySelector("header");
    if (header) {
        if (window.scrollY > 100) {
            header.style.opacity = "0.95";
            header.style.backdropFilter = "blur(10px)";
        } else {
            header.style.opacity = "0.9";
            header.style.backdropFilter = "none";
        }
    }
});

// Initialize Puter when page loads
window.addEventListener("load", () => {
    console.log(' zetsu window loaded, checking Puter...');
    if (!puterInitialized) {
        setTimeout(initializePuter, 1000);
    }
});

// Manual retry function for debugging
window.retryZetsuPuter = () => {
    console.log(' Manual zetsu Puter retry triggered...');
    puterInitialized = false;
    initializationAttempts = 0;
    initializePuter();
};

// Export functions for use in HTML
window.askQuestion = askQuestion;
window.toggleChat = toggleChat;